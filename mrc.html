<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Bootstrap CSS -->
	<link rel="stylesheet" media="all" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css">
	<link rel="stylesheet" media="all" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/6.6.6/css/flag-icons.min.css">
	<link rel="stylesheet" media="all" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" >
	<title>Monthly Installments Graph</title>
	<!-- Chart.js -->	
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<style>
		/* Chrome, Safari, Edge, Opera */
		input::-webkit-outer-spin-button,
		input::-webkit-inner-spin-button {
		  -webkit-appearance: none;
		  margin: 0;
		}

		/* Firefox */
		input[type=number] {
		  -moz-appearance: textfield;
		}	
		.chart_container {
			display: flex;
			justify-content: center;
			align-items: center;
			width: 70%;
			margin: auto;
			padding: 20px;
			background-color: powderblue;
		}		
		.slider {
		  width: 80%;
		  height: 20px;
		}

		.slider::-webkit-slider-thumb {
		  width: 20px;
		  height: 20px;
		}		
	</style>
</head>
<body>
<div class="container-xl">
	<div class="row">
		<div class="col-md-12 text-center">
			<h1 id="page_title"> Monthly Installments Graph</h1>
		</div>
	</div>		
	<div class="row">
		<div class="col-md-4">
			<div class="form-group text-center">
				<label class="font-weight-bold" for="principal">Principal:</label><br>
				<button class="btn shadow bg-green rounded" id="principal_plus" onclick="calculate('principal','minus',1000)">-</button>
				<input type="number" id="principal" style="text-align: center;">
				<button class="btn shadow bg-green rounded" id="principal_minus" onclick="calculate('principal','plus',1000)">+</button><br>
				<input class="slider" type="range" max="1000000" step="10000" id="principalSlider" onmousedown="updateFieldValue('principal')"><br>
			</div>
		</div>
		<div class="col-md-4">
			<div class="form-group text-center">
				<label class="font-weight-bold" for="rate">Rate (%):</label><br>
				<button class="btn shadow bg-green rounded" id="rate_plus" onclick="calculate('rate','minus', 0.01)">-</button>
				<input type="number" id="rate" style="text-align: center;">
				<button class="btn shadow bg-green rounded" id="rate_minus" onclick="calculate('rate','plus', 0.01)">+</button><br>
				<input class="slider" type="range" min="0" max="10" step="0.1" id="rateSlider" onmousedown="updateFieldValue('rate')"><br>
			</div>
		</div>
		<div class="col-md-4">
			<div class="form-group text-center">
				<label class="font-weight-bold" for="duration">Duration (years):</label><br>
				<button class="btn shadow bg-green rounded" id="duration_plus" onclick="calculate('duration','minus',1)">-</button>
				<input type="number" id="duration" style="text-align: center;">
				<button class="btn shadow bg-green rounded" id="duration_minus" onclick="calculate('duration','plus', 1)">+</button><br>
				<input class="slider" type="range" min="1" max="30" step="1" id="durationSlider" onmousedown="updateFieldValue('duration')"><br>
			</div>
		</div>
	</div>
	<div class="row">
		<div class="col-md-12 text-center">
			<button class="btn btn-primary" type="submit" onclick="updateChart()">Update Chart</button>	
		</div>
	</div>	
	<div class="row">
		<div class="col-md-12">
			<div class="chart_container width=1000px">
				<canvas id="myChart" ></canvas>
			</div>	
		</div>
	</div>
</div>
<script>
	function roundy(input,i){
		x = (Math.round(input * 100) / 100);
		return x;
	};
	
	function roundx(input, decimals) {
		return Number(Math.round(input+'e'+decimals)+'e-'+decimals);
	};
	
	function calculate(elem, action, val) {
		
		fieldname = document.getElementById(elem)
		if ((action === 'plus')) 
			{fieldname.value = roundx(parseFloat(fieldname.value) + parseFloat(val), 2);};
		if ((action === 'minus') && (fieldname.value > val)) 
			{fieldname.value = roundx(parseFloat(fieldname.value) - parseFloat(val), 2);};
		if (elem === 'duration') 
			{updateChart();};
	};
	
	function updateFieldValue(elem) {
		var slider_name = elem + "Slider"
		var fieldname = document.getElementById(elem)
		var slider = document.getElementById(slider_name);
		fieldname.value = slider.value;

		slider.oninput = function() {
		  fieldname.value = this.value;
		}
	};		
	
	// Get the input fields
	const principalInput = document.getElementById("principal");
	const rateInput = document.getElementById("rate");
	const durationInput = document.getElementById("duration");

	// Get the canvas element and create the initial chart
	const canvas = document.getElementById("myChart");
	const ctx = canvas.getContext("2d");

	let chartData = {
		labels: [],
		datasets: [
		  {
			label: "Balance",
			data: [],
			fill: false,
			borderColor: "green"
		  },
		  {
			label: "Interest paid",
			data: [],
			fill: false,
			borderColor: "red"
		  }			  
		]
	};

	let chartOptions = {
		responsive: true,
		maintainAspectRatio: true,
		scales: {
		  yAxes: [{
			ticks: {
			  beginAtZero: true
			}
		  }]
		}
	};

	let myChart = new Chart(ctx, {
		type: "line",
		data: chartData,
		options: chartOptions
	});
	
	function prepareData() {
		var principal = document.getElementById('principal').value;
		var rate = document.getElementById('rate').value;
		var duration = document.getElementById('duration').value*12;
		var monthlyRate = rate / 1200;
		var monthlyPayment = (monthlyRate + (monthlyRate / ((1 + monthlyRate) ** duration - 1))) * principal;

		var balance = principal;
		var balanceData = [principal];

		var interestData = [0.0];
		for (var i = 1; i <= duration; i++) {
			//calculate balance;
			var interest = balance * monthlyRate;
			var principalPaid = monthlyPayment - interest;
			balance = balance - principalPaid;
			if (balance < monthlyRate) {
				balance = 0;
			}
			balanceData.push((roundx(balance, 2)).toFixed(2));
			
			// Calculate paid interest;
			var prev_interest_val = interestData[i-1];
			var interest_cumsum = Number(interest) + Number(prev_interest_val);
			interestData.push((roundx(interest_cumsum, 2)).toFixed(2));
		}
		
		var result = {};		
		result["points"] = duration;
		result["datapoints"] = balanceData;
		result["interestpoints"] = interestData;
		result["monthly_payment"] = String( roundx(monthlyPayment,2));
		return result;
	};
  
	function updateChart() {
		results = prepareData();
		newDatapoints = results.datapoints.filter(function(value, index, Arr) {
			return index % 12 == 0;
		});
		newInterestpoints = results.interestpoints.filter(function(value, index, Arr) {
			return index % 12 == 0;
		});		
		myChart.data.labels =  Array.from({length: (results.points/12)+1}, (_, i) => `Year ${(i+1)-1}`),
		myChart.data.datasets[0].data = newDatapoints;
		myChart.data.datasets[1].data = newInterestpoints;
		myChart.update();
		document.getElementById("page_title").innerHTML = "Monthly Installments Graph - Â£"+ results.monthly_payment;
};	  
</script>
</body>
</html>
